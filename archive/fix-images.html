<!DOCTYPE html>
<html>
<head>
  <title>Fix Product Images</title>
  <style>
    body { font-family: Arial; padding: 40px; background: #f3f4f6; }
    .product { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    button { background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; margin: 5px; }
    button:hover { background: #5568d3; }
    button.fix { background: #10b981; }
    button.fix:hover { background: #059669; }
    .url { background: #f9fafb; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 11px; word-break: break-all; }
    img { max-width: 150px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; }
    .broken { border-color: red !important; }
    .fixed { border-color: green !important; }
  </style>
</head>
<body>
  <h1>üîß Fix Broken Product Images</h1>
  <button onclick="loadAndFixImages()">Load & Auto-Fix All Broken Images</button>
  <div id="log"></div>
  <div id="products"></div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(
      'https://cjicnsltjuatduzuwgoo.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqaWNuc2x0anVhdGR1enV3Z29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDYzMDMsImV4cCI6MjA3NjA4MjMwM30.w_OX2XY9TU8Cf3H_kVh8ivEMham8UNvifMJwxmgLGs4'
    );

    // Working placeholder images for different categories
    const placeholderImages = {
      'Bedsheets': 'https://images.unsplash.com/photo-1522771739844-6a9f6d5f14af?w=800',
      'Pillows': 'https://images.unsplash.com/photo-1584100936595-c0654b55a2e2?w=800',
      'Blankets': 'https://images.unsplash.com/photo-1616047006789-b7af5afb8c20?w=800',
      'Curtains': 'https://images.unsplash.com/photo-1634979150028-0e1e5e78bf28?w=800',
      'Cushions': 'https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=800',
      'Towels': 'https://images.unsplash.com/photo-1610557892470-55d9e80c0bce?w=800',
      'default': 'https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=800'
    };

    function getImageForCategory(category) {
      return placeholderImages[category] || placeholderImages['default'];
    }

    async function testImageUrl(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url;
        setTimeout(() => resolve(false), 5000);
      });
    }

    window.loadAndFixImages = async () => {
      const container = document.getElementById('products');
      const logDiv = document.getElementById('log');
      container.innerHTML = '<p>Loading products...</p>';
      logDiv.innerHTML = '';

      try {
        const { data: products, error } = await supabase
          .from('products')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        logDiv.innerHTML = `<div class="product"><h3>üìä Status</h3><p>Total products: ${products.length}</p><p>Checking images...</p></div>`;

        container.innerHTML = '';
        let fixedCount = 0;

        for (const product of products) {
          const isWorking = await testImageUrl(product.image);
          
          if (!isWorking) {
            const newImage = getImageForCategory(product.category_name);
            
            // Update in Supabase
            const { error: updateError } = await supabase
              .from('products')
              .update({ image: newImage })
              .eq('id', product.id);

            if (!updateError) {
              fixedCount++;
              const div = document.createElement('div');
              div.className = 'product';
              div.innerHTML = `
                <h3>‚úÖ Fixed: ${product.name}</h3>
                <p><strong>Category:</strong> ${product.category_name}</p>
                <div class="url"><strong>Old URL:</strong><br>${product.image}</div>
                <div class="url" style="background: #d1fae5;"><strong>New URL:</strong><br>${newImage}</div>
                <img src="${newImage}" class="fixed">
              `;
              container.appendChild(div);
            }
          }
        }

        logDiv.innerHTML = `<div class="product" style="background: #d1fae5;">
          <h3>‚úÖ Complete!</h3>
          <p>Fixed ${fixedCount} broken images</p>
          <button onclick="window.location.reload()">Refresh to verify</button>
        </div>`;

      } catch (error) {
        container.innerHTML = `<div class="product" style="border: 2px solid red;">
          <h3>‚ùå Error</h3>
          <pre>${error.message}</pre>
        </div>`;
      }
    };
  </script>
</body>
</html>
